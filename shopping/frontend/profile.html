<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸ªäººä¸­å¿ƒ</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus/dist/index.css"
    />
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <div id="app">
      <el-container class="app-container">
        <el-header class="app-header">
          <div class="header-content">
            <a href="./customer.html" class="logo-link">ğŸ›’ åœ¨çº¿è´­ç‰©å¹³å°</a>
            <div class="header-right">
              <el-button @click="goBack">è¿”å›é¦–é¡µ</el-button>
            </div>
          </div>
        </el-header>
        <el-main>
          <div class="profile-container">
            <div class="profile-sidebar">
              <div class="avatar-upload">
                <img
                  :src="getAvatarUrl(userInfo.avatar)"
                  :alt="userInfo.username"
                  class="avatar-preview"
                  @error="handleImageError"
                />
                <el-upload
                  :action="uploadUrl"
                  :headers="uploadHeaders"
                  :before-upload="beforeUpload"
                  :on-success="handleAvatarSuccess"
                  :show-file-list="false"
                >
                  <el-button type="primary">æ›´æ¢å¤´åƒ</el-button>
                </el-upload>
              </div>
            </div>
            <div class="profile-content">
              <h2>ä¸ªäººä¿¡æ¯</h2>
              <el-form
                :model="form"
                label-width="100px"
                style="max-width: 600px; margin-top: 30px"
              >
                <el-form-item label="ç”¨æˆ·å">
                  <el-input
                    v-model="form.username"
                    @blur="updateUsername"
                  ></el-input>
                </el-form-item>
                <el-form-item label="é‚®ç®±">
                  <el-input v-model="form.email" disabled></el-input>
                </el-form-item>
                <el-form-item label="è§’è‰²">
                  <el-tag :type="form.role === 1 ? 'success' : 'warning'">
                    {{ form.role === 1 ? 'é¡¾å®¢' : 'å•†å®¶' }}
                  </el-tag>
                  <el-button 
                    v-if="form.role === 2" 
                    type="primary" 
                    style="margin-left: 20px"
                    @click="goToMerchant"
                  >è¿›å…¥å•†å®¶ç®¡ç†</el-button>
                </el-form-item>
              </el-form>
            </div>
          </div>
        </el-main>
      </el-container>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="./js/api.js"></script>
    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            userInfo: {},
            form: {},
            uploadUrl: API_CONFIG.BASE_URL + "/user/avatar",
            uploadHeaders: {},
          };
        },
        mounted() {
          const token = localStorage.getItem("token");
          if (!token) {
            window.location.href = "./login.html";
            return;
          }
          this.uploadHeaders.Authorization = "Bearer " + token;
          this.loadUserInfo();
        },
        methods: {
          async loadUserInfo() {
            try {
              const res = await API.getUserInfo();
              if (res.code === 1) {
                this.userInfo = res.data;
                this.form = { ...res.data };
              }
            } catch (error) {
              ElMessage.error("åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥");
            }
          },
          async updateUsername() {
            if (this.form.username === this.userInfo.username) return;
            try {
              await API.updateUserInfo({ username: this.form.username });
              ElMessage.success("æ›´æ–°æˆåŠŸ");
              this.userInfo.username = this.form.username;
            } catch (error) {
              this.form.username = this.userInfo.username;
            }
          },
          beforeUpload(file) {
            const isImage = file.type.startsWith("image/");
            const isLt5M = file.size / 1024 / 1024 < 5;
            if (!isImage) {
              ElMessage.error("åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶");
              return false;
            }
            if (!isLt5M) {
              ElMessage.error("å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB");
              return false;
            }
            return true;
          },
          async handleAvatarSuccess(res) {
            if (res.code === 1) {
              ElMessage.success("å¤´åƒä¸Šä¼ æˆåŠŸ");
              await this.loadUserInfo();
            }
          },
          goBack() {
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
            if (userInfo.role === 2) {
              window.location.href = './merchant.html';
            } else {
              window.location.href = './customer.html';
            }
          },
          goToMerchant() {
            window.location.href = './merchant.html';
          },
          getAvatarUrl(avatar) {
            if (!avatar) return '/default-avatar.png';
            // å¦‚æœå·²ç»æ˜¯å®Œæ•´URLï¼ˆhttpå¼€å¤´ï¼‰ï¼Œç›´æ¥è¿”å›
            if (avatar.startsWith('http')) return avatar;
            // å¦åˆ™æ‹¼æ¥åŸºç¡€URL
            return API_CONFIG.BASE_URL + avatar;
          },
          handleImageError(event) {
            event.target.src = '/default-avatar.png';
          }
        },
      })
        .use(ElementPlus)
        .mount("#app");
    </script>
  </body>
</html>
